name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.2.3)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (execute all steps except tag creation)'
        required: false
        type: boolean
        default: false
      include_prereleases:
        description: 'Include pre-releases when resolving core version'
        required: false
        type: boolean
        default: false

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Stop services
        if: always()
        run: docker compose down || true

  resolve-core-version:
    runs-on: ubuntu-latest
    outputs:
      core_version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Get latest core tag
        id: get-version
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [ "${{ inputs.include_prereleases }}" == "true" ]; then
            # Include all tags
            LATEST=$(gh api repos/YggdrasilCloud/core/releases/latest --jq '.tag_name')
          else
            # Filter out pre-releases (tags containing '-')
            LATEST=$(gh api repos/YggdrasilCloud/core/releases \
              --jq '[.[] | select(.prerelease == false) | .tag_name] | first')
          fi

          if [ -z "$LATEST" ]; then
            echo "No suitable core release found"
            exit 1
          fi

          echo "Core version resolved: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

  trigger-e2e:
    needs: [build-and-test, resolve-core-version]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger E2E tests
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: YggdrasilCloud/tests-e2e
          event-type: test-frontend-release
          client-payload: |
            {
              "core_ref": "${{ needs.resolve-core-version.outputs.core_version }}",
              "frontend_ref": "${{ github.ref_name }}",
              "frontend_sha": "${{ github.sha }}",
              "triggered_by": "frontend",
              "target_version": "${{ inputs.version }}",
              "dry_run": ${{ inputs.dry_run }},
              "workflow_run_id": "${{ github.run_id }}"
            }

      - name: Wait for E2E tests to complete
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Waiting for E2E workflow to start..."
          sleep 10

          # Get the latest E2E workflow run triggered by repository_dispatch
          MAX_WAIT=600  # 10 minutes max
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get latest workflow run for E2E Tests
            RUN_ID=$(gh api repos/YggdrasilCloud/tests-e2e/actions/workflows/e2e-tests.yml/runs \
              --jq '.workflow_runs[0].id // empty' 2>/dev/null || echo "")

            if [ -n "$RUN_ID" ]; then
              echo "Found E2E workflow run: $RUN_ID"

              # Wait for it to complete
              gh run watch $RUN_ID --repo YggdrasilCloud/tests-e2e --exit-status

              echo "E2E tests completed successfully!"
              exit 0
            fi

            echo "Waiting for E2E workflow to start... ($ELAPSED/$MAX_WAIT seconds)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "Timeout waiting for E2E workflow to start"
          exit 1

  create-release:
    needs: [trigger-e2e, resolve-core-version]
    runs-on: ubuntu-latest
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write
    steps:
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GH_PAT }}
          tag_name: ${{ inputs.version }}
          generate_release_notes: true
          body: |
            ## Release ${{ inputs.version }}

            **Tested with:**
            - Frontend: `${{ github.ref_name }}` (${{ github.sha }})
            - Core: `${{ needs.resolve-core-version.outputs.core_version }}`

            Full E2E test report: [Workflow run](https://github.com/YggdrasilCloud/tests-e2e/actions)

  merge-pr:
    needs: [create-release]
    runs-on: ubuntu-latest
    if: ${{ !inputs.dry_run }}
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR if exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current branch name
          BRANCH_NAME=$(git branch --show-current)
          echo "Current branch: $BRANCH_NAME"

          # Find PR for this branch by filtering all open PRs
          PR_NUMBER=$(gh pr list \
            --repo ${{ github.repository }} \
            --state open \
            --json number,headRefName | \
            jq -r ".[] | select(.headRefName == \"${BRANCH_NAME}\") | .number")

          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for branch $BRANCH_NAME, skipping merge"
            exit 0
          fi

          echo "Found PR #$PR_NUMBER for branch $BRANCH_NAME, merging with rebase..."

          # Merge PR with rebase and merge strategy
          gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --rebase \
            --delete-branch \
            --body "Auto-merged after successful release ${{ inputs.version }}"

          echo "âœ… PR #$PR_NUMBER merged successfully"

  post-tag-verification:
    needs: [merge-pr, resolve-core-version]
    runs-on: ubuntu-latest
    if: ${{ !inputs.dry_run }}
    steps:
      - name: Trigger final E2E verification
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: YggdrasilCloud/tests-e2e
          event-type: verify-release
          client-payload: |
            {
              "core_ref": "${{ needs.resolve-core-version.outputs.core_version }}",
              "frontend_ref": "${{ inputs.version }}",
              "triggered_by": "frontend",
              "verification_type": "post-tag"
            }
